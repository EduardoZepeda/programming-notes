## 1.28 Autorización y autenticación

Cuando el API server recibe un request, intenta autorizarlo usando:

-   Certificados TLS
-   Bearer tokens
-   Basic Auth
-   Proxy de autenticación

Nota la ausencia de Oauth dentro de los mecanismos de autenticación.

Devolviendo un error 401 (unauthorized) en caso de que se rechace.

De manera predeterminada, un usuario anónimo es incapaz de realizar operaciones
en el cluster.

```bash
curl -k http://<direcion>
{
    "status": "forbidden",
    "message": "forbidden",
}
```

Para ver la configuración del kubectl del archivo kube config, que incluye los
usuarios y sus certificados TLS (encodeado en base 64)

```bash
kubectl config view --raw -o json
{    
    "users": [
    {
        "name": "kind-kind",
        "user": {
            "client-certificate-data": "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJYnF5dENYZ..."
        }
    }
}
```

### 1.28.1 Service account tokens

Este es un método de autenticación en kubernetes. Un service account puede
crearse, eliminarse y actualizarse, sirven para otorgar permisos a aplicaciones
y servicios

```bash
kubectl get serviceaccounts
kubectl get sa
```

esto nos mostrará el total de service accounts

```bash
NAME                               SECRETS   AGE
default                            1         4d20h
```

Por lo que ahora podemos obtener de uno en particular pasándoselo como un
parámetro extra

```bash
kubectl get sa default -o yml
apiVersion: v1
kind: ServiceAccount
metadata:
creationTimestamp: "2022-01-26T22:43:42Z"
name: default
namespace: default
resourceVersion: "403"
uid: a44307a3-d1ac-458f-9205-e1faea23e934
secrets:
- name: default-token-7djb7
```

Para

```bash
kubectl get secret default-token-00000 -o json

apiVersion: v1
data:
ca.crt: ABC==
namespace: ABC==
token: ABC
kind: Secret
metadata:
annotations:
    kubernetes.io/service-account.name: default
    kubernetes.io/service-account.uid: a44307f3-d1ac-458f-9205-e1faea23e933
creationTimestamp: "2022-01-26T22:43:42Z"
name: default-token-7djb7
namespace: default
resourceVersion: "399"
uid: 340e87b5-456b-4f8a-8e8c-56cf1b75d372
type: kubernetes.io/service-account-token
```

Y ahora podemos decodearlo en base 64

```bash
kubectl get secret default-token-00000 -o json | jq -r '.data.token' | base64 -d
```

Otra manera de obtener el token del usuario es ejecutando el siguiente comando.

```bash
kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')

Data
====
ca.crt:     1066 bytes
namespace:  11 bytes
token: ABC
```

Ahora simplemente utilizamos el token en el Authorization header

```bash
"Authorization: Bearer ABC.ED..."
```

